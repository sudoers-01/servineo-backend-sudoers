import type { Request, Response } from "express";
import mongoose from "mongoose";
import { Payment } from "../../models/payment.model";

type PaymentSummary = {
  _id: mongoose.Types.ObjectId;
  code: string;
  status: "paid" | "pending" | "failed";
  codeExpiresAt?: Date;
  amount: { total: number; currency: string };
};

export async function getPaymentSummaryByIdLab(req: Request, res: Response) {
  try {
    const { id } = req.params;

    console.log("üîç Consultando payment ID:", id); // LOG

    if (!mongoose.isValidObjectId(id)) {
      return res.status(400).json({ error: "id inv√°lido" });
    }

    const doc = await Payment.findById(id)
      .select({ "amount.total": 1, "amount.currency": 1, code: 1, status: 1, codeExpiresAt: 1 })
      .lean<PaymentSummary>();

    if (!doc) return res.status(404).json({ error: "no encontrado" });

    if (typeof doc?.amount?.total !== "number") {
      return res.status(422).json({ error: "documento sin 'amount.total' v√°lido" });
    }

    // ‚úÖ Verificar si el c√≥digo expir√≥
    const now = new Date();
    const codeExpired = doc.codeExpiresAt ? doc.codeExpiresAt < now : false;

    console.log("‚è∞ Verificaci√≥n de expiraci√≥n:", {
      now: now.toISOString(),
      codeExpiresAt: doc.codeExpiresAt?.toISOString() || "N/A",
      codeExpired,
      difference: doc.codeExpiresAt 
        ? ((doc.codeExpiresAt.getTime() - now.getTime()) / 1000).toFixed(2) + " segundos"
        : "N/A"
    }); // LOG

    const responseData = {
      data: {
        id,
        code: codeExpired ? null : doc.code,  // ‚úÖ Ocultar c√≥digo si expir√≥
        codeExpired,  // ‚úÖ Agregar flag de expiraci√≥n
        codeExpiresAt: doc.codeExpiresAt ?? null,
        status: doc.status,
        amount: {
          total: doc.amount.total,
          currency: doc.amount.currency ?? "BOB",
        }
      },
    };

    console.log("üì§ Respuesta enviada:", JSON.stringify(responseData, null, 2)); // LOG

    return res.json(responseData);
  } catch (e: any) {
    console.error("‚ùå Error obteniendo resumen:", e);
    return res.status(400).json({ error: e.message || "Error buscando resumen por id (lab)" });
  }
}
